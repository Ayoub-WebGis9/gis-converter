<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>CartoMaroc - Outils SIG</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { width: 100%; height: 100vh; }

  /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ£ÿØŸàÿßÿ™ */
  #toolbar {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 10px 14px;
    border-radius: 10px;
    z-index: 1000;
    display: flex;
    gap: 10px;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    font-size: 15px;
  }

  button {
    background:#0087d7;
    color:white;
    border:none;
    border-radius:8px;
    padding:8px 14px;
    cursor:pointer;
    font-size: 8px;
    transition: 0.2s;
  }
  button.active {
    background: #444;
    transform: scale(1.05);
  }
  button:hover { background:#005fa3; }

  /* ÿßŸÑÿ™ŸàŸÇŸäÿπ */
  #footer {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.8);
    padding: 6px 14px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    font-size: 14px;
  }

  .ol-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 3px 6px;
    border-radius: 4px;
    white-space: nowrap;
  }
  .ol-tooltip-static {
    background-color: #ffcc33;
    color: black;
    border: 1px solid white;
  }
</style>
</head>
<body>
  <div id="footer">¬© CartoMaroc</div>

  <div id="toolbar">
    <button id="drawPoint">üìç Point</button>
    <button id="drawLine">üìè Ligne</button>
    <button id="drawPolygon">‚¨† Polygone</button>
    <button id="deleteFeature">üßπ Supprimer</button>
    <button id="clearAll">üóë Effacer tout</button>
    <button id="downloadGeoJSON">üíæ T√©l√©charger GeoJSON</button>
  </div>

  <div id="map"></div>

<script>
  // --- Base Layers ---
  const satellite = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      attributions: 'Source: Esri, Earthstar Geographics'
    })
  });

  const labels = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
      attributions: 'Esri - Boundaries & Places'
    })
  });

  // --- Couche de dessin ---
  const source = new ol.source.Vector();
  const vector = new ol.layer.Vector({
    source: source,
    style: new ol.style.Style({
      fill: new ol.style.Fill({color: 'rgba(0, 200, 150, 0.4)'}),
      stroke: new ol.style.Stroke({color: '#00b894', width: 2}),
      image: new ol.style.Circle({radius: 6, fill: new ol.style.Fill({color: '#0984e3'})})
    })
  });

  // --- Initialisation de la carte ---
  const map = new ol.Map({
    target: 'map',
    layers: [satellite, labels, vector],
    view: new ol.View({ center: ol.proj.fromLonLat([-9, 30]), zoom: 6 })
  });

  let draw = null;
  let activeButton = null;
  let deleteMode = false;

  // --- Tooltip ---
  const overlay = new ol.Overlay({
    element: document.createElement('div'),
    offset: [0, -15],
    positioning: 'bottom-center'
  });
  overlay.getElement().className = 'ol-tooltip ol-tooltip-static';
  map.addOverlay(overlay);

  // --- Clic sur la carte ---
  map.on('click', function(evt) {
    if (draw) return;

    if (deleteMode) {
      // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ŸÉŸÑ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸäŸá
      map.forEachFeatureAtPixel(evt.pixel, function(feature) {
        if (confirm("üßπ Supprimer cet √©l√©ment ?")) {
          source.removeFeature(feature);
        }
      });
      return;
    }

    overlay.setPosition(undefined);
    map.forEachFeatureAtPixel(evt.pixel, function(feature) {
      const coord = evt.coordinate;
      overlay.getElement().innerHTML = feature.get('popup') || '';
      overlay.setPosition(coord);
    });
  });

  // --- Fonction pour activer le dessin ---
  function toggleDraw(type, buttonId) {
    const button = document.getElementById(buttonId);
    if (activeButton === button) {
      deactivateDraw();
      return;
    }
    deactivateDraw();
    deleteMode = false;

    activeButton = button;
    button.classList.add('active');
    draw = new ol.interaction.Draw({ source: source, type: type });
    map.addInteraction(draw);

    draw.on('drawend', function(e) {
      const feature = e.feature;
      const geom = feature.getGeometry();
      const name = prompt("üìù Entrez le nom de la forme :", "Objet_" + (source.getFeatures().length));
      feature.set('name', name || "Objet");

      let text = "";
      if (geom.getType() === "Point") {
        const coord = ol.proj.toLonLat(geom.getCoordinates());
        text = `Longitude: ${coord[0].toFixed(6)}<br>Latitude: ${coord[1].toFixed(6)}`;
      } else if (geom.getType() === "LineString") {
        const length = ol.sphere.getLength(geom);
        text = `Longueur: ${(length/1000).toFixed(3)} km (${length.toFixed(0)} m)`;
      } else if (geom.getType() === "Polygon") {
        const area = ol.sphere.getArea(geom);
        text = `Surface: ${area.toFixed(0)} m¬≤ (${(area/10000).toFixed(3)} ha, ${(area/1e6).toFixed(4)} km¬≤)`;
      }

      feature.set('popup', `<b>${feature.get('name')}</b><br>${text}`);
      deactivateDraw();
    });
  }

  // --- D√©sactivation du dessin ---
  function deactivateDraw() {
    if (draw) {
      map.removeInteraction(draw);
      draw = null;
    }
    if (activeButton) {
      activeButton.classList.remove('active');
      activeButton = null;
    }
  }

  // --- Boutons ---
  document.getElementById('drawPoint').onclick = () => toggleDraw('Point', 'drawPoint');
  document.getElementById('drawLine').onclick = () => toggleDraw('LineString', 'drawLine');
  document.getElementById('drawPolygon').onclick = () => toggleDraw('Polygon', 'drawPolygon');

  document.getElementById('deleteFeature').onclick = function() {
    deactivateDraw();
    deleteMode = !deleteMode;
    this.classList.toggle('active');
  };

  document.getElementById('clearAll').onclick = () => {
    if (confirm("‚ö†Ô∏è Supprimer tous les objets ?")) {
      source.clear();
      overlay.setPosition(undefined);
    }
  };

  document.getElementById('downloadGeoJSON').onclick = () => {
    if (source.getFeatures().length === 0) {
      alert("‚ö†Ô∏è Aucun objet dessin√© !");
      return;
    }
    const format = new ol.format.GeoJSON();
    const json = format.writeFeatures(source.getFeatures(), {
      featureProjection: map.getView().getProjection(),
      dataProjection: 'EPSG:4326'
    });
    const blob = new Blob([json], {type: "application/geo+json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const date = new Date().toISOString().slice(0,19).replace(/[T:]/g,"-");
    a.download = "CartoMaroc_"+date+".geojson";
    a.click();
    URL.revokeObjectURL(url);
  };
</script>
</body>
</html>
